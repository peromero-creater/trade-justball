<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LW Charts — Minimal Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Pin to v4 UMD bundle -->
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body{margin:0;background:#0f1115;color:#e4e7ec;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    #app{padding:18px}
    #c{height:520px;border:1px solid #242b3a;border-radius:12px}
    #err{white-space:pre-wrap;color:#ff6b6b;margin-top:12px}
  </style>
</head>
<body>
  <div id="app">
    <h2>Lightweight Charts — Minimal</h2>
    <div id="c"></div>
    <div id="err"></div>
  </div>

  <script>
    const showErr = m => document.getElementById('err').textContent = String(m||'');
    window.addEventListener('error', e => showErr(e.message));
    window.addEventListener('unhandledrejection', e => showErr(e.reason?.message || e.reason || e));

    // 1) Library sanity check
    if (!window.LightweightCharts || !LightweightCharts.createChart) {
      showErr('LightweightCharts failed to load'); throw new Error('LW not loaded');
    }

    // 2) Create chart (rename variable so it can’t clash with #c)
    const container = document.getElementById('c');
    const lwChart = LightweightCharts.createChart(container, {
      layout: { background: { type: 'Solid', color: '#0f1115' }, textColor: '#d0d2d6' },
      grid:   { vertLines: { color: '#1b1e26' }, horzLines: { color: '#1b1e26' } },
      timeScale: { timeVisible: true, secondsVisible: true }
    });

    const candles = lwChart.addCandlestickSeries();
    const volume  = lwChart.addHistogramSeries({ priceScaleId: '' });
    lwChart.priceScale('').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

    // 3) Generate a small random history and set it
    const now = Math.floor(Date.now()/1000);
    const step = 60; // 1m
    let t = now - 60*60*3; // last 3h
    t -= t % step;
    let price = 64000;
    const bars = [];
    while (t < now) {
      const o = price;
      const c = o + (Math.random()*2 - 1)*25;
      const h = Math.max(o, c) + Math.random()*10;
      const l = Math.min(o, c) - Math.random()*10;
      const v = Math.abs(5 + (Math.random()-0.5)*2);
      bars.push({ time:t, open:+o.toFixed(2), high:+h.toFixed(2), low:+l.toFixed(2), close:+c.toFixed(2), volume:+v.toFixed(4) });
      price = c; t += step;
    }
    candles.setData(bars);
    volume.setData(bars.map(b => ({ time:b.time, value:b.volume, color:b.close>=b.open ? '#26a69a' : '#ef5350' })));

    // 4) Keep it ticking in demo
    let last = bars[bars.length-1];
    setInterval(() => {
      const n = Math.floor(Date.now()/1000);
      const onNewBar = n >= last.time + step;
      if (onNewBar) {
        last = { time: n - (n%step), open: last.close, high: last.close, low: last.close, close: last.close, volume: 0 };
      }
      const c = last.close + (Math.random()*2-1)*6;
      last.high = Math.max(last.high, c);
      last.low  = Math.min(last.low, c);
      last.close = +c.toFixed(2);
      last.volume = +(last.volume + Math.abs((Math.random()-0.5)*0.2)).toFixed(4);
      candles.update(last);
      volume.update({ time:last.time, value:last.volume, color:last.close>=last.open ? '#26a69a' : '#ef5350' });
    }, 1000);
  </script>
</body>
</html>
