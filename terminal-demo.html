<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BARSOL — Trading Terminal (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{--bg:#0f1115;--panel:#141822;--border:#242b3a;--text:#e4e7ec;--muted:#9aa3b2;--up:#26a69a;--down:#ef5350;--accent:#7fd18c}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    /* 3 columns: chart 40% (smaller than half), ticket 25%, depth 35% */
    .wrap{display:grid;grid-template-columns:minmax(420px,40%) minmax(320px,25%) 1fr;grid-template-rows:auto 1fr auto;gap:14px;height:100vh;padding:14px;box-sizing:border-box}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:12px;min-width:0;display:flex;flex-direction:column}
    .head{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .body{padding:10px;flex:1;min-height:0}
    .brand{font-weight:700}
    .muted{color:var(--muted)}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1115;font-variant-numeric:tabular-nums}
    .pill.up{color:var(--up)} .pill.down{color:var(--down)}
    input,select,button{background:#0f1115;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 8px}
    button{cursor:pointer;background:#1e2636}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #tv{height:60vh;border-radius:10px} /* chart height smaller */
    .tabs{display:flex;gap:6px;margin-bottom:10px}
    .tabs button{padding:6px 10px;border-radius:8px}
    .tabs .on{outline:2px solid var(--accent)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid #1b1e26}
    .bid{color:var(--up)} .ask{color:var(--down)}
    .buy{background:#16312c} .sell{background:#3a1e24}
    .btn-buy{background:#0f2f24;border-color:#0f2f24} .btn-sell{background:#38161e;border-color:#38161e}
    .btn-xs{padding:4px 8px;border-radius:6px}
    .totals{display:flex;justify-content:space-between;margin-top:8px;font-size:12px}
    #err{white-space:pre-wrap;color:#ff6b6b;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- CHART (col1) -->
    <div class="card" style="grid-column:1 / span 1; grid-row:1 / span 2;">
      <div class="head">
        <div class="row">
          <span class="brand">BARSOL —</span>
          <span id="titleSym">BTC/USDT</span>
          <span id="pricePill" class="pill">—</span>
          <span id="ohlc" class="muted"></span>
        </div>
        <div class="row">
          <label class="muted">Symbol</label><input id="sym" value="BTCUSDT" size="10"/>
          <label class="muted">Res</label>
          <select id="res"><option>1</option><option>5</option><option>15</option><option>60</option><option>1D</option></select>
          <label class="muted">Type</label>
          <select id="type"><option value="candle" selected>Candles</option><option value="line">Line</option></select>
          <button id="apply">Load</button>
        </div>
      </div>
      <div class="body">
        <div id="tv"></div>
        <div class="row" style="margin-top:8px">
          <button id="zoom30">30m</button><button id="zoom2h">2h</button><button id="zoom1d">1D</button>
          <label class="muted">SMA</label><label><input id="sma20" type="checkbox" checked>20</label><label><input id="sma50" type="checkbox">50</label>
          <span id="status" class="muted" style="margin-left:auto"></span>
        </div>
        <div id="err"></div>
      </div>
    </div>

    <!-- ORDER TICKET (col2) -->
    <div class="card" style="grid-column:2 / span 1; grid-row:1 / span 2;">
      <div class="head"><strong>Trade Ticket</strong><span id="ticketSym" class="muted">BTCUSDT</span></div>
      <div class="body">
        <div class="tabs">
          <button id="tabBuy"  class="on">Buy</button>
          <button id="tabSell">Sell</button>
          <button id="tabSwap">Swap</button>
        </div>

        <!-- Buy/Sell form -->
        <div id="formTrade">
          <div class="grid2">
            <label>Type
              <select id="ordType"><option>Market</option><option>Limit</option></select>
            </label>
            <label>Price
              <input id="price" type="number" step="0.01" placeholder="auto" />
            </label>
            <label>Quantity
              <input id="qty" type="number" step="0.0001" value="0.01" />
            </label>
            <label>Notional (USDT)
              <input id="notional" type="number" step="0.01" readonly />
            </label>
          </div>
          <div class="totals">
            <span class="muted">Fee (demo): 0</span>
            <span class="muted">Mode: <strong>DEMO</strong></span>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnPlace" class="btn-xs btn-buy">Place BUY</button>
            <button id="btnCloseAll" class="btn-xs">Close All</button>
          </div>
        </div>

        <!-- Swap form (demo) -->
        <div id="formSwap" style="display:none">
          <div class="grid2">
            <label>From
              <select id="swapFrom"><option>BTC</option><option>USDT</option></select>
            </label>
            <label>To
              <select id="swapTo"><option>USDT</option><option>BTC</option></select>
            </label>
            <label>Amount
              <input id="swapAmt" type="number" step="0.0001" value="0.01"/>
            </label>
            <label>Estimate
              <input id="swapEst" type="text" readonly />
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnSwap" class="btn-xs">Swap (demo)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DEPTH (col3) -->
    <div class="card" style="grid-column:3 / span 1; grid-row:1 / span 2;">
      <div class="head"><strong>Depth (Top 10)</strong></div>
      <div class="body" style="overflow:auto">
        <table>
          <thead><tr><th class="bid">Bid P</th><th class="bid">Bid Q</th><th></th><th class="ask">Ask P</th><th class="ask">Ask Q</th></tr></thead>
          <tbody id="depthBody"></tbody>
        </table>
      </div>
    </div>

    <!-- POSITIONS (bottom, spans all) -->
    <div class="card" style="grid-column:1 / span 3; grid-row:3 / span 1;">
      <div class="head">
        <strong>Open Positions</strong>
        <div class="row">
          <label class="muted">Search</label><input id="posSearch" placeholder="Filter by symbol/side"/>
        </div>
      </div>
      <div class="body" style="overflow:auto">
        <table id="posTable">
          <thead>
            <tr>
              <th>Symbol</th><th>Side</th><th>Qty</th><th>Avg Price</th><th>Mark</th><th>Unreal. PnL</th><th></th>
            </tr>
          </thead>
          <tbody id="posBody"></tbody>
        </table>
        <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
        <strong>Order History</strong>
        <table id="histTable" style="margin-top:6px">
          <thead>
            <tr><th>Time</th><th>Symbol</th><th>Side</th><th>Type</th><th>Qty</th><th>Price</th><th>Status</th></tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
  // ======== DEMO / LIVE SWITCH ========
  const DEMO = true; // set to false and fill the 3 endpoints when Kenan is ready
  const API_HISTORY = 'https://YOUR_API/history';
  const WS_BARS     = 'wss://YOUR_API/ws/bars';
  const WS_DEPTH    = 'wss://YOUR_API/ws/depth';
  // ====================================

  const $ = id => document.getElementById(id);
  const statusEl = $('status'), pill=$('pricePill'), titleSym=$('titleSym'), ohlcEl=$('ohlc');
  let lastBar=null, prevPrice=null, priceLine=null, wsBars=null, wsDepth=null, demoBarTimer=null, demoDepthTimer=null;

  // --- Chart setup ---
  const container = $('tv');
  const chart = LightweightCharts.createChart(container, {
    layout:{background:{type:'Solid',color:'#0f1115'}, textColor:'#d0d2d6'},
    grid:{vertLines:{color:'#1b1e26'}, horzLines:{color:'#1b1e26'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    timeScale:{timeVisible:true, secondsVisible:true}
  });
  let mainSeries = chart.addCandlestickSeries();
  const volSeries = chart.addHistogramSeries({ priceScaleId:'' });
  chart.priceScale('').applyOptions({ scaleMargins:{ top:0.8, bottom:0 } });
  let sma20 = chart.addLineSeries({ color:'#7fd18c', lineWidth:1 });
  let sma50 = chart.addLineSeries({ color:'#5da1ff', lineWidth:1 });

  const msToSec = t => (t>1e12?Math.floor(t/1000):t);
  const fromUDF = j => j.t.map((t,i)=>({ time:t, open:+j.o[i], high:+j.h[i], low:+j.l[i], close:+j.c[i], volume:+j.v[i] }));
  const fromArr = a => a.map(b=>({ time:msToSec(b.time), open:+b.open, high:+b.high, low:+b.low, close:+b.close, volume:+b.volume }));
  const setVols = bars => volSeries.setData(bars.map(b=>({time:b.time,value:b.volume,color:b.close>=b.open?'#26a69a':'#ef5350'})));
  const stepOf = r => r==='1D'?86400:r==='60'?3600:r==='15'?900:r==='5'?300:60;
  function SMA(bars, n){const out=[];let s=0,q=[];for(const b of bars){q.push(b.close);s+=b.close;if(q.length>n){s-=q.shift()}if(q.length===n){out.push({time:b.time,value:+(s/n).toFixed(2)})}}return out}
  const titleOf = s => `${s.slice(0,3)}/${s.slice(3)}`;

  function setPricePill(price, symbol) {
    const p = +price; pill.textContent = p.toLocaleString('en-US',{maximumFractionDigits:2});
    pill.classList.remove('up','down'); if (prevPrice!=null) pill.classList.add(p>=prevPrice?'up':'down'); prevPrice=p;
    if (!priceLine) priceLine = mainSeries.createPriceLine({ price:p, color:'#7fd18c', lineStyle:LightweightCharts.LineStyle.Dotted, axisLabelVisible:true, title:symbol });
    priceLine.applyOptions({ price:p, title:symbol });
  }

  async function fetchTicker(symbol){
    try{ const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${encodeURIComponent(symbol)}`);
      const j = await r.json(); if (j?.price) setPricePill(j.price, titleOf(symbol)); return j?.price?+j.price:null;
    }catch{ return null; }
  }

  function genHistory(res, hours=6, seed=64000){
    const step=stepOf(res); const to=Math.floor(Date.now()/1000);
    let t=Math.floor((to-hours*3600)/step)*step, price=seed, out=[];
    while(t<to){
      const o=price, c=o+(Math.random()*2-1)*25, h=Math.max(o,c)+Math.random()*10, l=Math.min(o,c)-Math.random()*10, v=Math.abs(5+(Math.random()-0.5)*2);
      out.push({time:t,open:+o.toFixed(2),high:+h.toFixed(2),low:+l.toFixed(2),close:+c.toFixed(2),volume:+v.toFixed(4)}); price=c; t+=step;
    } return out;
  }
  function genDepth(mid=64200){const bids=[],asks=[];for(let i=1;i<=10;i++){bids.push([+(mid-i*5).toFixed(2),+(0.2+i*0.05).toFixed(4)]);asks.push([+(mid+i*5).toFixed(2),+(0.2+i*0.05).toFixed(4)])}return{bids,asks,ts:Math.floor(Date.now()/1000)}}
  function paintDepth(book){
    const tb=$('depthBody'); const bids=(book.bids||[]).slice(0,10), asks=(book.asks||[]).slice(0,10); const n=Math.max(bids.length,asks.length);
    const rows=[]; for(let i=0;i<n;i++){const b=bids[i]||['',''], a=asks[i]||['','']; rows.push(`<tr><td class="bid">${b[0]??''}</td><td class="bid">${b[1]??''}</td><td></td><td class="ask">${a[0]??''}</td><td class="ask">${a[1]??''}</td></tr>`);} tb.innerHTML=rows.join('');
  }

  async function loadHistory(symbol,res,type){
    titleSym.textContent = titleOf(symbol); $('ticketSym').textContent = symbol;
    const seed = await fetchTicker(symbol) || 64000;
    const bars = DEMO ? genHistory(res,6,seed) : await (async ()=>{
      const to=Math.floor(Date.now()/1000), from=to-60*60*6;
      const url=`${API_HISTORY}?symbol=${encodeURIComponent(symbol)}&resolution=${res}&from=${from}&to=${to}`;
      const r=await fetch(url); const j=await r.json();
      return (j && j.s==='ok') ? fromUDF(j) : Array.isArray(j) ? fromArr(j) : [];
    })();

    if (mainSeries) chart.removeSeries(mainSeries);
    mainSeries = (type==='line') ? chart.addLineSeries({color:'#e4e7ec',lineWidth:2}) : chart.addCandlestickSeries();
    if (type==='line') mainSeries.setData(bars.map(b=>({time:b.time,value:b.close}))); else mainSeries.setData(bars);
    setVols(bars);
    $('sma20').checked ? sma20.setData(SMA(bars,20)) : sma20.setData([]);
    $('sma50').checked ? sma50.setData(SMA(bars,50)) : sma50.setData([]);
    lastBar = bars.at(-1) || null;
    if (lastBar) setPricePill(lastBar.close, titleOf(symbol));
    statusEl.textContent = DEMO ? `demo: ${bars.length} bars` : `loaded ${bars.length} bars`;

    chart.subscribeCrosshairMove(param=>{
      const d = param.seriesData.get(mainSeries);
      if (!d){ ohlcEl.textContent=''; return; }
      if (type==='line'){ ohlcEl.textContent = `C ${d.value}`; }
      else { const {open,high,low,close} = d; ohlcEl.textContent = `O ${open}  H ${high}  L ${low}  C ${close}`; }
    });
  }

  function startRealtime(symbol,res,type){
    clearInterval(demoBarTimer); if (wsBars) wsBars.close();
    if (DEMO){
      const step=stepOf(res);
      demoBarTimer=setInterval(()=>{
        const now=Math.floor(Date.now()/1000);
        if (!lastBar || now-lastBar.time>=step){
          const o = lastBar ? lastBar.close : prevPrice || 64000;
          lastBar = { time: now-(now%step), open:o, high:o, low:o, close:o, volume:0 };
        }
        const c = lastBar.close + (Math.random()*2-1)*6;
        lastBar.high=Math.max(lastBar.high,c); lastBar.low=Math.min(lastBar.low,c);
        lastBar.close=+c.toFixed(2); lastBar.volume=+(lastBar.volume+Math.abs((Math.random()-0.5)*0.2)).toFixed(4);
        if (type==='line') mainSeries.update({time:lastBar.time,value:lastBar.close}); else mainSeries.update(lastBar);
        volSeries.update({time:lastBar.time,value:lastBar.volume,color:lastBar.close>=lastBar.open?'#26a69a':'#ef5350'});
        setPricePill(lastBar.close, titleOf(symbol));
        updateMarkAndPnL(lastBar.close);
      },1000);
    } else {
      wsBars = new WebSocket(`${WS_BARS}?symbol=${encodeURIComponent(symbol)}&res=${encodeURIComponent(res)}`);
      wsBars.onmessage = ev=>{
        const m = JSON.parse(ev.data);
        const b = m.t?{time:m.t,open:+m.o,high:+m.h,low:+m.l,close:+m.c,volume:+m.v}:{time:msToSec(m.time),open:+m.open,high:+m.high,low:+m.low,close:+m.close,volume:+m.volume};
        if (type==='line') mainSeries.update({time:b.time,value:b.close}); else mainSeries.update(b);
        volSeries.update({time:b.time,value:b.volume,color:b.close>=b.open?'#26a69a':'#ef5350'});
        setPricePill(b.close, titleOf(symbol)); updateMarkAndPnL(b.close); lastBar=b;
      };
    }
    // depth
    clearInterval(demoDepthTimer); if (wsDepth) wsDepth.close();
    if (DEMO){ demoDepthTimer=setInterval(()=>paintDepth(genDepth(prevPrice||64000)),1000); }
    else { wsDepth=new WebSocket(`${WS_DEPTH}?symbol=${encodeURIComponent(symbol)}`); wsDepth.onmessage=ev=>paintDepth(JSON.parse(ev.data)); }
  }

  // --- Controls ---
  $('apply').onclick = ()=> boot();
  $('zoom30').onclick = ()=> zoomMins(30);
  $('zoom2h').onclick  = ()=> zoomMins(120);
  $('zoom1d').onclick  = ()=> zoomMins(1440);
  $('sma20').onchange  = ()=> boot();
  $('sma50').onchange  = ()=> boot();
  function zoomMins(m){ const to=Math.floor(Date.now()/1000); chart.timeScale().setVisibleRange({from:to-m*60,to}); }
  async function boot(){
    const sym=$('sym').value.trim().toUpperCase(), res=$('res').value, type=$('type').value;
    await loadHistory(sym,res,type); startRealtime(sym,res,type);
    history.replaceState(null,'',`?symbol=${sym}&res=${res}&type=${type}`);
  }

  // ========= ORDER TICKET / POSITIONS (demo) =========
  let side = 'BUY';
  const positions = []; // {symbol, side, qty, avg}
  const history   = []; // simple log

  function renderPositions(mark){
    const q = $('posSearch').value.trim().toUpperCase();
    const rows = positions
      .filter(p => !q || p.symbol.includes(q) || p.side.includes(q))
      .map(p=>{
        const pnl = (p.side==='BUY' ? (mark - p.avg) : (p.avg - mark)) * p.qty;
        const cls = pnl>=0?'bid':'ask';
        return `<tr>
          <td>${p.symbol}</td><td>${p.side}</td>
          <td>${p.qty}</td><td>${p.avg.toFixed(2)}</td><td>${mark?mark.toFixed(2):'-'}</td>
          <td class="${cls}">${(pnl||0).toFixed(2)}</td>
          <td><button class="btn-xs" data-close="${p.symbol}|${p.side}">Close</button></td>
        </tr>`;
      }).join('');
    $('posBody').innerHTML = rows || `<tr><td colspan="7" class="muted">No positions</td></tr>`;
    // wire close
    document.querySelectorAll('button[data-close]').forEach(b=>{
      b.onclick = () => {
        const [symbol, s] = b.dataset.close.split('|');
        closePosition(symbol, s, lastBar?.close || prevPrice || 0);
      };
    });
  }
  function renderHistory(){
    $('histBody').innerHTML = history.slice(-100).reverse().map(h=>{
      return `<tr><td>${new Date(h.ts).toLocaleTimeString()}</td><td>${h.symbol}</td><td>${h.side}</td><td>${h.type}</td><td>${h.qty}</td><td>${h.price}</td><td>${h.status}</td></tr>`;
    }).join('');
  }
  function updateMarkAndPnL(mark){ renderPositions(mark); }

  function placeOrder(){
    const symbol = $('sym').value.trim().toUpperCase();
    const type = $('ordType').value;
    const qty = +$('qty').value || 0;
    let px = +$('price').value || lastBar?.close || prevPrice || 0;
    if (type==='Market') px = lastBar?.close || prevPrice || px;
    if (!qty || !px) return;
    const existing = positions.find(p=>p.symbol===symbol && p.side===side);
    if (existing){
      // new average
      existing.avg = (existing.avg*existing.qty + px*qty) / (existing.qty + qty);
      existing.qty = +(existing.qty + qty).toFixed(4);
    } else {
      positions.push({ symbol, side, qty:+qty, avg:+px });
    }
    history.push({ ts:Date.now(), symbol, side, type, qty, price:+px, status:'filled' });
    renderHistory(); renderPositions(px);
  }
  function closePosition(symbol, s, px){
    const i = positions.findIndex(p=>p.symbol===symbol && p.side===s);
    if (i>=0){
      const p = positions[i];
      history.push({ ts:Date.now(), symbol, side:s==='BUY'?'SELL':'BUY', type:'Market', qty:p.qty, price:+px, status:'closed' });
      positions.splice(i,1); renderHistory(); renderPositions(px);
    }
  }

  $('tabBuy').onclick  = ()=>{ side='BUY'; $('tabBuy').classList.add('on'); $('tabSell').classList.remove('on'); $('tabSwap').classList.remove('on'); $('formTrade').style.display='block'; $('formSwap').style.display='none'; $('btnPlace').textContent='Place BUY'; $('btnPlace').classList.add('btn-buy'); $('btnPlace').classList.remove('btn-sell'); };
  $('tabSell').onclick = ()=>{ side='SELL';$('tabSell').classList.add('on'); $('tabBuy').classList.remove('on'); $('tabSwap').classList.remove('on'); $('formTrade').style.display='block'; $('formSwap').style.display='none'; $('btnPlace').textContent='Place SELL';$('btnPlace').classList.remove('btn-buy'); $('btnPlace').classList.add('btn-sell'); };
  $('tabSwap').onclick = ()=>{ $('tabSwap').classList.add('on'); $('tabBuy').classList.remove('on'); $('tabSell').classList.remove('on'); $('formTrade').style.display='none'; $('formSwap').style.display='block'; };
  $('btnPlace').onclick = placeOrder;
  $('btnCloseAll').onclick = ()=>{ positions.slice().forEach(p=>closePosition(p.symbol, p.side, lastBar?.close || prevPrice || 0)); };
  $('qty').oninput = ()=>{ const px=+$('price').value || lastBar?.close || prevPrice || 0; $('notional').value = (px*(+$('qty').value||0)).toFixed(2); };
  $('price').oninput = ()=>{ $('qty').dispatchEvent(new Event('input')); };
  $('posSearch').oninput = ()=> renderPositions(lastBar?.close || prevPrice || 0);

  // swap demo
  $('swapFrom').onchange = calcSwap; $('swapTo').onchange = calcSwap; $('swapAmt').oninput = calcSwap;
  function calcSwap(){
    const from=$('swapFrom').value, to=$('swapTo').value, amt=+$('swapAmt').value||0;
    const price = lastBar?.close || prevPrice || 0;
    let est = 0;
    if (from==='BTC' && to==='USDT') est = amt * price;
    else if (from==='USDT' && to==='BTC') est = amt / (price||1);
    $('swapEst').value = est ? est.toFixed(6) : '';
  }
  $('btnSwap').onclick = ()=>{ calcSwap(); alert('Swap (demo) executed.'); };

  // init
  const qp=new URLSearchParams(location.search);
  if (qp.get('symbol')) $('sym').value = qp.get('symbol').toUpperCase();
  if (qp.get('res')) $('res').value = qp.get('res');
  if (qp.get('type')) $('type').value = qp.get('type');

  $('apply').click(); // boot once
</script>
</body>
</html>
